<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Équations</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;1,300;1,400&family=DM+Mono:wght@300&display=swap" rel="stylesheet">
<style>
:root {
  --bg:    #f4efe8;
  --ink:   #2c2620;
  --mink:  #8c7e70;
  --taupe: #b4a898;
  --fog:   rgba(44,38,32,0.22);
  --serif: 'Cormorant Garamond', Georgia, serif;
  --mono:  'DM Mono', monospace;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); }

body {
  /* Fond photo LOV exact :
     - haut-gauche : quasi blanc chaud #f8f4ee (là où la lumière frappe)
     - centre-haut : transition vers gris argenté chaud
     - bas-droite : taupe rosé sombre #b8a898
     La lumière vient du haut-gauche à ~10h */
  background:
    radial-gradient(ellipse 70% 60% at 8% 8%,  #faf7f2 0%, transparent 48%),
    radial-gradient(ellipse 55% 45% at 30% 5%,  #f2ede4 0%, transparent 50%),
    radial-gradient(ellipse 50% 55% at 88% 92%, #b0a090 0%, transparent 48%),
    radial-gradient(ellipse 40% 40% at 72% 78%, #c4b8a8 0%, transparent 45%),
    linear-gradient(138deg, #f0ebe2 0%, #e4ddd0 35%, #cfc5b5 65%, #bdb0a0 100%);
  font-family: var(--serif);
  color: var(--ink);
  user-select: none;
}

/* grain photo */
body::after {
  content:''; position:fixed; inset:0; z-index:1; pointer-events:none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='280'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.68' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='matrix' values='0.8 0.1 0.1 0 0  0.1 0.75 0.1 0 0  0.05 0.05 0.7 0 0  0 0 0 1 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='0.038'/%3E%3C/svg%3E");
  background-size: 280px 280px;
  mix-blend-mode: multiply;
  opacity: 1;
}

#three { position:fixed; inset:0; z-index:0; }

/* ── HEADER ── */
.hd {
  position:fixed; top:0; left:0; right:0; z-index:100;
  padding:26px 40px;
  display:flex; align-items:flex-start; justify-content:space-between;
  pointer-events:none;
}
.brand {
  font-family:var(--serif); font-style:italic; font-weight:300;
  font-size:0.8rem; letter-spacing:0.22em; color:var(--mink); opacity:0.65;
}


.hd-right { text-align:right; }
.score-l { font-family:var(--mono); font-size:0.48rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--taupe); display:block; }
.score-n { font-family:var(--serif); font-style:italic; font-weight:300; font-size:3.2rem; color:var(--ink); line-height:1; opacity:0.7; }
.prog-line { width:72px; height:1px; margin:7px 0 0 auto; background:rgba(44,38,32,0.1); position:relative; }
.prog-fill { height:100%; background:rgba(44,38,32,0.38); transition:width 0.9s cubic-bezier(0.16,1,0.3,1); }
.prog-txt { font-family:var(--mono); font-size:0.45rem; letter-spacing:0.1em; color:var(--taupe); margin-top:4px; text-align:right; }

/* ── ÉQUATION CENTRALE EN BAS ── */
.eq-zone {
  position:fixed; bottom:0; left:0; right:0; z-index:100;
  display:flex; flex-direction:column; align-items:center;
  padding-bottom:28px; pointer-events:none;
}

.eq-disp {
  font-family:var(--serif); font-style:italic; font-weight:300;
  font-size:2.6rem; color:var(--ink); opacity:0.82;
  letter-spacing:0.04em; text-align:center; margin-bottom:5px;
  transition:all 0.35s;
}
.eq-disp .xp { color:rgba(200,100,60,0.85); }
.eq-disp .np { color:rgba(60,100,170,0.85); }
.eq-state {
  font-family:var(--serif); font-style:italic; font-weight:300;
  font-size:0.82rem; letter-spacing:0.07em;
  color:var(--mink); opacity:0; transition:opacity 0.45s, color 0.35s;
  margin-bottom:16px;
}
.eq-state.show { opacity:0.75; }
.eq-state.heavy { color:rgba(180,80,50,0.82); opacity:0.82; }
.eq-state.solved { color:rgba(70,120,70,0.9); opacity:1; font-size:1.05rem; }

/* ── CONTRÔLES LATÉRAUX ── */
.ctrl {
  position:fixed; top:50%; z-index:100;
  transform:translateY(-50%);
  display:flex; flex-direction:column; gap:5px;
  pointer-events:all;
}
.ctrl-l { left:28px; }
.ctrl-r { right:28px; }

.op {
  display:flex; align-items:center; gap:7px;
  padding:6px 11px; border-radius:8px;
  border:1px solid rgba(44,38,32,0.09);
  background:rgba(245,240,233,0.5);
  backdrop-filter:blur(14px);
  cursor:pointer; transition:all 0.18s;
  font-family:var(--serif); font-size:0.8rem;
  color:var(--mink); opacity:0.6; white-space:nowrap;
}
.ctrl-r .op { flex-direction:row-reverse; }
.op:hover { background:rgba(255,255,255,0.78); border-color:rgba(44,38,32,0.2); color:var(--ink); opacity:1; transform:translateX(0) !important; }
.op:active { transform:scale(0.97) !important; }
.op[data-off="true"] { opacity:0.13; pointer-events:none; }
.op-i {
  width:20px; height:20px; border-radius:5px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-family:var(--mono); font-size:0.75rem;
}
.op.ax .op-i { background:rgba(200,100,60,0.12); color:rgba(190,80,40,0.85); }
.op.rx .op-i { background:rgba(200,100,60,0.07); color:rgba(190,80,40,0.45); }
.op.an .op-i { background:rgba(60,100,180,0.12); color:rgba(50,90,170,0.85); }
.op.rn .op-i { background:rgba(60,100,180,0.07); color:rgba(50,90,170,0.45); }

/* Bouton diviser - style distinct */
.op.div { opacity: 0.75; }
.op.div .op-i { 
  background: rgba(140,120,100,0.15); 
  color: rgba(120,100,80,0.9);
  font-size: 0.68rem;
}
.op.div:hover { opacity: 1; }

/* Sélecteur de diviseur */
.div-selector {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  z-index: 700; display: none;
}
.div-selector.show { display: block; animation: fOv 0.25s ease; }

.div-selector-bg {
  position: fixed; inset: 0; background: rgba(198,190,178,0.4);
  backdrop-filter: blur(12px);
}
.div-selector-card {
  position: relative; z-index: 1;
  background: rgba(248,245,240,0.98); border: 1px solid rgba(175,163,148,0.22);
  border-radius: 20px; padding: 32px 40px;
  box-shadow: 0 24px 70px rgba(88,76,64,0.18);
  animation: cPop 0.4s cubic-bezier(0.16,1,0.3,1);
}
.div-title {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 1.8rem; color: var(--ink); margin-bottom: 6px;
}
.div-subtitle {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.18em;
  text-transform: uppercase; color: var(--taupe); margin-bottom: 24px;
}
.div-options {
  display: flex; gap: 10px; margin-bottom: 20px;
}
.div-opt {
  width: 52px; height: 52px; border-radius: 12px;
  background: rgba(255,255,255,0.5); border: 1px solid rgba(44,38,32,0.12);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--serif); font-style: italic; font-size: 1.6rem;
  color: var(--ink); cursor: pointer; transition: all 0.2s;
}
.div-opt:hover { background: rgba(255,255,255,0.9); border-color: rgba(44,38,32,0.3); transform: translateY(-2px); }
.div-opt[data-disabled="true"] { opacity: 0.2; pointer-events: none; }

.div-actions {
  display: flex; gap: 8px; justify-content: flex-end;
}
.div-btn {
  font-family: var(--serif); font-style: italic; font-size: 0.88rem;
  padding: 8px 20px; border-radius: 10px; cursor: pointer;
  transition: all 0.2s; border: 1px solid;
}
.div-btn.cancel {
  background: transparent; border-color: rgba(44,38,32,0.18);
  color: var(--mink);
}
.div-btn.cancel:hover { background: rgba(44,38,32,0.05); border-color: rgba(44,38,32,0.3); }

.ctrl-lbl { font-family:var(--mono); font-size:0.44rem; letter-spacing:0.16em; text-transform:uppercase; color:var(--taupe); opacity:0.45; text-align:center; margin-top:3px; }

/* ── BARRE ACTIONS ── */
.bar {
  position:fixed; bottom:26px; left:50%; transform:translateX(-50%);
  z-index:100; display:flex; gap:6px; pointer-events:all;
}
.ba {
  font-family:var(--serif); font-style:italic;
  font-size:0.76rem; letter-spacing:0.05em;
  padding:7px 17px; border-radius:8px;
  cursor:pointer; transition:all 0.2s;
  border:1px solid rgba(44,38,32,0.1);
  background:rgba(245,240,233,0.55); backdrop-filter:blur(14px);
  color:var(--mink); opacity:0.6;
}
.ba:hover { opacity:1; background:rgba(255,255,255,0.8); border-color:rgba(44,38,32,0.2); color:var(--ink); transform:translateY(-1px); }
.ba.primary {
  font-style:normal; font-size:0.68rem; letter-spacing:0.12em;
  text-transform:uppercase;
  background:rgba(44,38,32,0.88); color:rgba(245,240,233,0.92);
  opacity:1; border-color:transparent; box-shadow:0 3px 14px rgba(44,38,32,0.14);
}
.ba.primary:hover { background:rgba(44,38,32,1); box-shadow:0 5px 20px rgba(44,38,32,0.2); }

/* Indice */
.hint-box {
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:120px; z-index:100; max-width:380px; width:88%;
  background:rgba(245,241,235,0.9); backdrop-filter:blur(16px);
  border:1px solid rgba(150,130,110,0.2); border-radius:10px;
  padding:11px 16px;
  font-family:var(--serif); font-style:italic; font-size:0.82rem;
  color:var(--mink); line-height:1.62; text-align:center;
  display:none; animation:sIn 0.28s ease;
}
@keyframes sIn { from{opacity:0;transform:translateX(-50%) translateY(4px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }

/* Panel historique */
.h-btn {
  position:fixed; top:50%; right:0; transform:translateY(-50%);
  z-index:200; display:none; /* hidden, toggled via résolution button */
}
.h-panel {
  position:fixed; right:0; top:0; bottom:0; z-index:150; width:260px;
  background:rgba(244,240,234,0.94); backdrop-filter:blur(24px);
  border-left:1px solid rgba(44,38,32,0.07);
  transform:translateX(100%); transition:transform 0.42s cubic-bezier(0.16,1,0.3,1);
  overflow-y:auto; padding:76px 22px 28px; pointer-events:all;
}
.h-panel.open { transform:translateX(0); }
.h-ttl { font-family:var(--mono); font-size:0.48rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--taupe); margin-bottom:14px; }
.h-close { position:absolute; top:26px; right:20px; font-family:var(--mono); font-size:0.46rem; letter-spacing:0.12em; color:var(--taupe); cursor:pointer; text-transform:uppercase; padding:4px 8px; }
.h-close:hover { color:var(--ink); }
.steps { display:flex; flex-direction:column; gap:4px; }
.step { padding:6px 9px; border-radius:7px; background:rgba(255,255,255,0.35); border:1px solid rgba(44,38,32,0.05); animation:pIn 0.25s ease; }
.step.s0  { background:rgba(150,130,110,0.05); }
.step.sok { background:rgba(80,130,80,0.06); border-color:rgba(80,130,80,0.14); }
@keyframes pIn { from{opacity:0;transform:translateX(4px)} to{opacity:1;transform:none} }
.sn { font-family:var(--mono); font-size:0.48rem; color:var(--taupe); }
.so { font-family:var(--mono); font-size:0.52rem; color:var(--mink); margin:1px 0; }
.se { font-family:var(--serif); font-size:0.82rem; color:var(--ink); }
.se .xv { color:rgba(190,80,40,0.82); font-style:italic; }
.se .nv { color:rgba(50,90,170,0.82); }

/* Overlays */
.ov { position:fixed; inset:0; z-index:500; display:none; align-items:center; justify-content:center; background:rgba(198,190,178,0.48); backdrop-filter:blur(22px) saturate(1.12); }
.ov.show { display:flex; animation:fOv 0.32s ease; }
@keyframes fOv { from{opacity:0} to{opacity:1} }
.card { background:rgba(248,245,240,0.97); border:1px solid rgba(175,163,148,0.22); border-radius:20px; padding:48px 52px; text-align:center; max-width:330px; margin:14px; box-shadow:0 24px 70px rgba(88,76,64,0.15), 0 1px 0 rgba(255,255,255,0.95) inset; animation:cPop 0.48s cubic-bezier(0.16,1,0.3,1); }
@keyframes cPop { from{transform:scale(0.86) translateY(16px);opacity:0} to{transform:none;opacity:1} }
.ci { font-size:2.5rem; display:block; margin-bottom:9px; }
.ct { font-family:var(--serif); font-style:italic; font-weight:300; font-size:2.1rem; color:var(--ink); line-height:1.1; margin-bottom:6px; }
.cd { width:28px; height:1px; background:linear-gradient(90deg,transparent,rgba(140,125,110,0.3),transparent); margin:9px auto; }
.ce { font-family:var(--mono); font-size:0.9rem; color:#5a4e42; letter-spacing:0.1em; background:rgba(150,130,110,0.08); border:1px solid rgba(150,130,110,0.16); padding:7px 18px; border-radius:8px; display:inline-block; margin:9px 0; }
.cs { font-family:var(--serif); font-style:italic; font-size:0.78rem; color:var(--mink); margin-bottom:20px; line-height:1.55; }
.cb { font-family:var(--serif); font-style:italic; font-size:0.88rem; letter-spacing:0.06em; padding:10px 30px; border-radius:10px; border:1px solid rgba(44,38,32,0.18); background:transparent; color:var(--ink); cursor:pointer; transition:all 0.2s; }
.cb:hover { background:var(--ink); color:#f5f0e8; border-color:transparent; }
.cb.w { background:rgba(150,130,110,0.1); border-color:rgba(150,130,110,0.28); color:#5a4e42; }
.cb.w:hover { background:#8c7e70; color:white; }

/* ── TABLEAU DE BORD ── */
.dash-btn {
  position: fixed; top: 26px; right: 40px; z-index: 100;
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.13em;
  text-transform: uppercase; padding: 6px 14px; border-radius: 20px;
  background: rgba(245,240,233,0.6); backdrop-filter: blur(14px);
  border: 1px solid rgba(44,38,32,0.14); color: var(--mink);
  cursor: pointer; transition: all 0.2s; pointer-events: all;
}
.dash-btn:hover { background: rgba(255,255,255,0.85); border-color: rgba(44,38,32,0.3); color: var(--ink); }

.dashboard {
  position: fixed; inset: 0; z-index: 600; background: rgba(198,190,178,0.5);
  backdrop-filter: blur(26px) saturate(1.15);
  display: none; align-items: center; justify-content: center;
  animation: fOv 0.35s ease;
}
.dashboard.show { display: flex; }

.dash-card {
  background: rgba(248,245,240,0.98); border: 1px solid rgba(175,163,148,0.22);
  border-radius: 24px; padding: 50px 60px; max-width: 900px; width: 90%; max-height: 85vh;
  overflow-y: auto; box-shadow: 0 28px 80px rgba(88,76,64,0.18), 0 1px 0 rgba(255,255,255,0.96) inset;
  animation: cPop 0.5s cubic-bezier(0.16,1,0.3,1);
}
.dash-close {
  float: right; font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--taupe); cursor: pointer; padding: 4px 10px;
}
.dash-close:hover { color: var(--ink); }

.dash-title {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 2.8rem; color: var(--ink); margin-bottom: 8px; clear: both;
}
.dash-subtitle {
  font-family: var(--mono); font-size: 0.52rem; letter-spacing: 0.2em;
  text-transform: uppercase; color: var(--taupe); margin-bottom: 40px;
}

/* Stats globales */
.dash-stats {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px; margin-bottom: 50px;
}
.stat-box {
  background: rgba(255,255,255,0.5); border: 1px solid rgba(44,38,32,0.08);
  border-radius: 14px; padding: 20px 24px; text-align: center;
}
.stat-num {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 3.2rem; color: var(--ink); line-height: 1;
}
.stat-label {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.18em;
  text-transform: uppercase; color: var(--taupe); margin-top: 6px;
}

/* Niveaux */
.dash-levels {
  display: grid; gap: 24px;
}
.level-card {
  background: rgba(255,255,255,0.4); border: 1px solid rgba(44,38,32,0.08);
  border-radius: 16px; padding: 24px 28px; transition: all 0.25s;
}
.level-card:hover { background: rgba(255,255,255,0.65); border-color: rgba(44,38,32,0.15); }
.level-card.locked { opacity: 0.4; pointer-events: none; }

.level-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
}
.level-name {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 1.6rem; color: var(--ink);
}
.level-badge {
  font-family: var(--mono); font-size: 0.45rem; letter-spacing: 0.15em;
  text-transform: uppercase; padding: 4px 12px; border-radius: 12px;
  background: rgba(44,38,32,0.06); color: var(--taupe);
}
.level-badge.complete { background: rgba(80,130,80,0.15); color: rgba(60,110,60,0.9); }
.level-badge.locked { background: rgba(44,38,32,0.04); color: rgba(44,38,32,0.2); }

.level-prog {
  display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
}
.level-bar {
  flex: 1; height: 6px; background: rgba(44,38,32,0.08); border-radius: 10px; overflow: hidden;
}
.level-bar-fill {
  height: 100%; background: linear-gradient(90deg, rgba(44,38,32,0.6), rgba(44,38,32,0.8));
  transition: width 0.6s cubic-bezier(0.16,1,0.3,1);
}
.level-frac {
  font-family: var(--mono); font-size: 0.5rem; color: var(--mink); min-width: 50px;
}

.level-types {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px;
}
.type-tag {
  font-family: var(--mono); font-size: 0.44rem; letter-spacing: 0.08em;
  padding: 4px 10px; border-radius: 8px; background: rgba(150,130,110,0.08);
  border: 1px solid rgba(150,130,110,0.12); color: var(--mink);
}

/* ── TABLEAU DE BORD ── */
.dash-btn {
  position: fixed; top: 26px; right: 40px; z-index: 100;
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.13em;
  text-transform: uppercase; padding: 6px 14px; border-radius: 20px;
  background: rgba(245,240,233,0.6); backdrop-filter: blur(14px);
  border: 1px solid rgba(44,38,32,0.14); color: var(--mink);
  cursor: pointer; transition: all 0.2s; pointer-events: all;
}
.dash-btn:hover { background: rgba(255,255,255,0.85); border-color: rgba(44,38,32,0.3); color: var(--ink); }

.dashboard {
  position: fixed; inset: 0; z-index: 600; background: rgba(198,190,178,0.5);
  backdrop-filter: blur(26px) saturate(1.15);
  display: none; align-items: center; justify-content: center;
  animation: fOv 0.35s ease;
}
.dashboard.show { display: flex; }

.dash-card {
  background: rgba(248,245,240,0.98); border: 1px solid rgba(175,163,148,0.22);
  border-radius: 24px; padding: 50px 60px; max-width: 900px; width: 90%; max-height: 85vh;
  overflow-y: auto; box-shadow: 0 28px 80px rgba(88,76,64,0.18), 0 1px 0 rgba(255,255,255,0.96) inset;
  animation: cPop 0.5s cubic-bezier(0.16,1,0.3,1);
}
.dash-close {
  float: right; font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--taupe); cursor: pointer; padding: 4px 10px;
}
.dash-close:hover { color: var(--ink); }

.dash-title {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 2.8rem; color: var(--ink); margin-bottom: 8px; clear: both;
}
.dash-subtitle {
  font-family: var(--mono); font-size: 0.52rem; letter-spacing: 0.2em;
  text-transform: uppercase; color: var(--taupe); margin-bottom: 40px;
}

/* Stats globales */
.dash-stats {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px; margin-bottom: 50px;
}
.stat-box {
  background: rgba(255,255,255,0.5); border: 1px solid rgba(44,38,32,0.08);
  border-radius: 14px; padding: 20px 24px; text-align: center;
}
.stat-num {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 3.2rem; color: var(--ink); line-height: 1;
}
.stat-label {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.18em;
  text-transform: uppercase; color: var(--taupe); margin-top: 6px;
}

/* Niveaux */
.dash-levels {
  display: grid; gap: 24px;
}
.level-card {
  background: rgba(255,255,255,0.4); border: 1px solid rgba(44,38,32,0.08);
  border-radius: 16px; padding: 24px 28px; transition: all 0.25s;
}
.level-card:hover { background: rgba(255,255,255,0.65); border-color: rgba(44,38,32,0.15); }
.level-card.locked { opacity: 0.4; pointer-events: none; }

.level-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
}
.level-name {
  font-family: var(--serif); font-style: italic; font-weight: 300;
  font-size: 1.6rem; color: var(--ink);
}
.level-badge {
  font-family: var(--mono); font-size: 0.45rem; letter-spacing: 0.15em;
  text-transform: uppercase; padding: 4px 12px; border-radius: 12px;
  background: rgba(44,38,32,0.06); color: var(--taupe);
}
.level-badge.complete { background: rgba(80,130,80,0.15); color: rgba(60,110,60,0.9); }
.level-badge.locked { background: rgba(44,38,32,0.04); color: rgba(44,38,32,0.2); }

.level-prog {
  display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
}
.level-bar {
  flex: 1; height: 6px; background: rgba(44,38,32,0.08); border-radius: 10px; overflow: hidden;
}
.level-bar-fill {
  height: 100%; background: linear-gradient(90deg, rgba(44,38,32,0.6), rgba(44,38,32,0.8));
  transition: width 0.6s cubic-bezier(0.16,1,0.3,1);
}
.level-frac {
  font-family: var(--mono); font-size: 0.5rem; color: var(--mink); min-width: 50px;
}

.level-types {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px;
}
.type-tag {
  font-family: var(--mono); font-size: 0.44rem; letter-spacing: 0.08em;
  padding: 4px 10px; border-radius: 8px; background: rgba(150,130,110,0.08);
  border: 1px solid rgba(150,130,110,0.12); color: var(--mink);
}

.page-in { animation:pgIn 1.1s cubic-bezier(0.16,1,0.3,1) both; }
@keyframes pgIn { from{opacity:0;transform:scale(0.985)} to{opacity:1;transform:none} }
</style>
</head>
<body class="page-in">

<canvas id="three"></canvas>

<header class="hd">
  <div class="brand">Balance — équations</div>
  <div class="hd-right">
    <span class="score-l">Points</span>
    <div class="score-n" id="sc">0</div>
    <div class="prog-line"><div class="prog-fill" id="pFill"></div></div>
    <div class="prog-txt" id="pTxt">0 / 4</div>
  </div>
</header>

<!-- Bouton tableau de bord -->
<div class="dash-btn" onclick="toggleDash()">Progression</div>

<!-- Sélecteur de diviseur -->
<div class="div-selector" id="divSelector">
  <div class="div-selector-bg" onclick="closeDivSelector()"></div>
  <div class="div-selector-card">
    <div class="div-title">Diviser par...</div>
    <div class="div-subtitle">Choisir le diviseur</div>
    <div class="div-options" id="divOptions"></div>
    <div class="div-actions">
      <button class="div-btn cancel" onclick="closeDivSelector()">Annuler</button>
    </div>
  </div>
</div>

<!-- Tableau de bord -->
<div class="dashboard" id="dashboard">
  <div class="dash-card">
    <div class="dash-close" onclick="toggleDash()">Fermer ✕</div>
    <div class="dash-title">Tableau de bord</div>
    <div class="dash-subtitle">Progression équations collège</div>
    
    <!-- Stats globales -->
    <div class="dash-stats">
      <div class="stat-box">
        <div class="stat-num" id="statTotal">0</div>
        <div class="stat-label">Équations résolues</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="statScore">0</div>
        <div class="stat-label">Points totaux</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="statPerfect">0</div>
        <div class="stat-label">Sans indice</div>
      </div>
    </div>
    
    <!-- Niveaux -->
    <div class="dash-levels" id="dashLevels"></div>
  </div>
</div>

<!-- Contrôles gauche -->
<div class="ctrl ctrl-l">
  <div class="op ax" onclick="go('l','a','x')"><div class="op-i">+</div><span>x</span></div>
  <div class="op an" onclick="go('l','a','n')"><div class="op-i">+</div><span>1</span></div>
  <div class="op rx" id="rlx" onclick="go('l','r','x')"><div class="op-i">−</div><span>x</span></div>
  <div class="op rn" id="rln" onclick="go('l','r','n')"><div class="op-i">−</div><span>1</span></div>
  <div class="op div" id="dL" onclick="divide('l')"><div class="op-i">÷</div><span>diviser</span></div>
  <div class="ctrl-lbl">Gauche</div>
</div>

<!-- Contrôles droite -->
<div class="ctrl ctrl-r">
  <div class="op ax" onclick="go('r','a','x')"><div class="op-i">+</div><span>x</span></div>
  <div class="op an" onclick="go('r','a','n')"><div class="op-i">+</div><span>1</span></div>
  <div class="op rx" id="rrx" onclick="go('r','r','x')"><div class="op-i">−</div><span>x</span></div>
  <div class="op rn" id="rrn" onclick="go('r','r','n')"><div class="op-i">−</div><span>1</span></div>
  <div class="op div" id="dR" onclick="divide('r')"><div class="op-i">÷</div><span>diviser</span></div>
  <div class="ctrl-lbl">Droite</div>
</div>

<!-- Zone équation -->
<div class="eq-zone">
  <div class="eq-disp" id="eDisp">x = ?</div>
  <div class="eq-state" id="eSt">Manipule les plateaux</div>
</div>

<div class="hint-box" id="hbox"></div>

<!-- Barre -->
<div class="bar">
  <button class="ba" onclick="showHint()">Indice</button>
  <button class="ba" onclick="doReset()">Recommencer</button>
  <button class="ba primary" onclick="doNext()">Suivant</button>
  <button class="ba" onclick="toggleH()">Résolution</button>
</div>

<!-- Panel historique -->
<div class="h-panel" id="hPanel">
  <div class="h-close" onclick="toggleH()">Fermer ×</div>
  <div class="h-ttl">Résolution</div>
  <div class="steps" id="steps"></div>
</div>

<!-- Overlay succès -->
<div class="ov" id="ovS">
  <div class="card">
    <span class="ci" id="oI">✦</span>
    <div class="ct">Bravo.</div><div class="cd"></div>
    <div class="ce" id="oE">x = 5</div>
    <div class="cs" id="oS">+15 points</div>
    <button class="cb" onclick="closeS()">Continuer →</button>
  </div>
</div>



<!-- Overlay déblocage -->
<div class="ov" id="ovU">
  <div class="card">
    <span class="ci">◈</span>
    <div class="ct" id="oUT">5ème<br>débloqué.</div><div class="cd"></div>
    <div class="cs" id="oUS">Tu maîtrises les équations de 6ème.</div>
    <button class="cb w" onclick="closeU()">Continuer →</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/* ═══════════════════════════════════════
   THREE.JS — BALANCE FIDÈLE AU SVG
   Forme : fléau elliptique, colonne fine,
   plateaux en coupelle, pivot anneau,
   poids en flèches triangulaires
═══════════════════════════════════════ */

const renderer = new THREE.WebGLRenderer({
  canvas: document.getElementById('three'),
  antialias: true, alpha: true
});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
// ACES Filmic — reproduit le contraste doux et les hautes lumières chaudes de la photo
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.02;   // légèrement sous-exposé comme un scan argentique
renderer.outputEncoding = THREE.sRGBEncoding;

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(38, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 0.8, 11);  // position initiale
camera.lookAt(0, 0.2, 0);

/* ─── LUMIÈRES — reproduction exacte photo LOV ───
   
   Analyse de la photo :
   - Source principale : softbox haut-gauche (≈10h), lumière très douce, large
     Teinte : blanc légèrement froid #fff8f2 (lumière studio neutre)
     Angle : position(-6, 10, 3) — vient de la gauche et du dessus
   - Ombre portée : vers bas-droite, très douce (radius élevé), teinte taupe chaud
   - Fill léger : côté droit, très doux, chaud, pour éviter les noirs purs
   - Ambiante : très faible, teinte beige chaud du fond
   ─────────────────────────────────────────── */

// SOURCE PRINCIPALE — softbox haut-gauche 10h
// Grande zone de lumière, ombres très douces
const sun = new THREE.DirectionalLight(0xfff6ee, 2.6);
sun.position.set(-6, 10, 3);    // haut-gauche, légèrement devant
sun.castShadow = true;
sun.shadow.mapSize.set(4096, 4096);   // haute résolution pour douceur
sun.shadow.camera.near = 0.5;
sun.shadow.camera.far  = 32;
sun.shadow.camera.left  = -10;
sun.shadow.camera.right =  10;
sun.shadow.camera.top   =  10;
sun.shadow.camera.bottom = -10;
sun.shadow.radius = 20;          // ombre très douce, diffuse
sun.shadow.blurSamples = 32;
scene.add(sun);

// FILL DROIT BAS — lumière de rebond du fond chaud
// Adoucit les ombres, teinte chaude taupe
const fill = new THREE.DirectionalLight(0xf0e4d0, 0.38);
fill.position.set(7, -2, 4);    // droite et bas
scene.add(fill);

// FILL DEVANT — légère lumière frontale pour la lisibilité
const front = new THREE.DirectionalLight(0xf8f2e8, 0.18);
front.position.set(0, 2, 8);
scene.add(front);

// AMBIANCE — beige très chaud du fond studio
scene.add(new THREE.AmbientLight(0xf0e8dc, 0.16));

// HÉMISPHÉRIQUE — ciel blanc chaud, sol taupe
// Simule la lumière diffuse de l'environnement studio
scene.add(new THREE.HemisphereLight(
  0xfff4e8,   // ciel : blanc chaud
  0xc8b8a4,   // sol  : taupe rosé (réflexion du fond)
  0.28
));

/* ─── MATÉRIAUX — argenté satiné photo LOV ───
   
   Analyse de la photo :
   - Zones illuminées : presque blanc froid (#f2f0ee), très brillant
   - Zones sombres : taupe-beige (#8a8278), jamais noires
   - Surface : métal brossé satiné — roughness 0.25-0.38 (pas miroir, pas mat)
   - Metalness : très élevé 0.95-0.98
   - Couleur de base : argenté légèrement chaud, avec teinte beige
   ─────────────────────────────────────────── */
const M = {
  // Argenté très clair LOV — presque blanc dans les highlights
  steel: new THREE.MeshStandardMaterial({
    color: 0xebe7e3,        // argenté très clair, chaud
    roughness: 0.20,        // brossé brillant
    metalness: 0.98,
  }),
  // Socle — même tonalité, légèrement plus sombre
  base: new THREE.MeshStandardMaterial({
    color: 0xdcd8d4,
    roughness: 0.26,
    metalness: 0.97,
  }),
  // Pivot — le plus brillant (arêtes vives blanches)
  pivot: new THREE.MeshStandardMaterial({
    color: 0xf2eee8,        // presque blanc
    roughness: 0.12,        // très brillant
    metalness: 0.99,
  }),
  // Plateaux — argenté clair uniforme
  plate: new THREE.MeshStandardMaterial({
    color: 0xe6e2de,
    roughness: 0.22,
    metalness: 0.98,
  }),
  // Fléau — argenté clair principal
  beam: new THREE.MeshStandardMaterial({
    color: 0xebe7e3,
    roughness: 0.20,
    metalness: 0.98,
  }),
  // Parties sombres — taupe rosé chaud (comme ombres photo)
  dark: new THREE.MeshStandardMaterial({
    color: 0xc4beb8,        // taupe clair rosé
    roughness: 0.28,
    metalness: 0.96,
  }),
  // Cubes — même argenté que la balance
  wx: new THREE.MeshStandardMaterial({
    color: 0xe2ded8,
    roughness: 0.24,
    metalness: 0.97,
  }),
  wn: new THREE.MeshStandardMaterial({
    color: 0xd8d4d0,
    roughness: 0.26,
    metalness: 0.96,
  }),
};

/* ─── GROUPE PRINCIPAL ─── */
const root = new THREE.Group();
root.position.y = 1.5;  // remonter légèrement
root.scale.set(0.80, 0.80, 0.80);  // rétrécir légèrement (80%)
scene.add(root);

/* ─── SOCLE — cylindre complet évasé ─── */
// Base évasée complète (cylindre à 360°)
const baseG = new THREE.CylinderGeometry(1.0, 1.2, 0.22, 64);
const base  = new THREE.Mesh(baseG, M.base);
base.position.y = -3.1;
base.castShadow = true; base.receiveShadow = true;
root.add(base);

// Plateau supérieur circulaire complet
const baseTopG = new THREE.CylinderGeometry(1.0, 1.0, 0.06, 64);
const baseTop  = new THREE.Mesh(baseTopG, M.dark);
baseTop.position.y = -2.99;
root.add(baseTop);

// Bord arrondi du socle (finition)
const baseRimG = new THREE.TorusGeometry(1.0, 0.03, 16, 64);
const baseRim = new THREE.Mesh(baseRimG, M.steel);
baseRim.rotation.x = Math.PI / 2;
baseRim.position.y = -2.96;
root.add(baseRim);

/* ─── COLONNE — deux tiges cylindriques parallèles ─── */
function addCol(xOff) {
  const g = new THREE.CylinderGeometry(0.065, 0.08, 3.4, 20);
  const m = new THREE.Mesh(g, M.steel);
  m.position.set(xOff, -1.28, 0);
  m.castShadow = true;
  root.add(m);
}
addCol(-0.14);
addCol( 0.14);

// Barrette horizontale reliant les deux colonnes (en bas)
const barBotG = new THREE.CylinderGeometry(0.06, 0.06, 0.32, 16);
barBotG.rotateZ(Math.PI/2);
const barBot = new THREE.Mesh(barBotG, M.dark);
barBot.position.set(0, -2.9, 0);
root.add(barBot);

// Barrette horizontale (haut, sous le pivot)
const barTopG = new THREE.CylinderGeometry(0.055, 0.055, 0.32, 16);
barTopG.rotateZ(Math.PI/2);
const barTop = new THREE.Mesh(barTopG, M.dark);
barTop.position.set(0, 0.44, 0);
root.add(barTop);

/* ─── PIVOT — double anneau concentrique ─── */
// Anneau extérieur (blanc nacré comme le SVG)
const pivExtG = new THREE.TorusGeometry(0.32, 0.06, 20, 64);
const pivExt  = new THREE.Mesh(pivExtG, M.pivot);
pivExt.position.y = 0.62;
pivExt.castShadow = true;
root.add(pivExt);

// Disque intérieur (grisé comme le SVG)
const pivIntG = new THREE.CylinderGeometry(0.23, 0.23, 0.06, 48);
const pivInt  = new THREE.Mesh(pivIntG, M.dark);
pivInt.position.y = 0.62;
root.add(pivInt);

/* ─── FLÉAU — ellipsoïde très aplati horizontal ─── */
const beamGroup = new THREE.Group();
beamGroup.position.y = 0.62;
root.add(beamGroup);

// Corps principal du fléau : ellipsoïde aplati
const beamG = new THREE.SphereGeometry(1, 64, 16);
beamG.scale(5.2, 0.18, 0.32); // Très allongé horizontalement, plat
const beam = new THREE.Mesh(beamG, M.beam);
beam.castShadow = true;
beamGroup.add(beam);

// Renfort central plus épais
const beamCenterG = new THREE.SphereGeometry(1, 32, 16);
beamCenterG.scale(0.6, 0.26, 0.38);
const beamCenter = new THREE.Mesh(beamCenterG, M.steel);
beamGroup.add(beamCenter);

/* ─── TIGES DE SUSPENSION (du fléau vers les plateaux) ─── */
function makeSuspension(xPos) {
  // Deux fils/tiges fines
  [-0.06, 0.06].forEach(xOff => {
    const g = new THREE.CylinderGeometry(0.018, 0.018, 1.8, 10);
    const m = new THREE.Mesh(g, M.dark);
    m.position.set(xPos + xOff, -1.0, 0);
    beamGroup.add(m);
  });
}
makeSuspension(-4.8);
makeSuspension( 4.8);

/* ─── PLATEAUX — plateaux plats circulaires ─── */
function makeBowl(xPos) {
  const group = new THREE.Group();
  group.position.set(xPos, -1.95, 0);  // position originale
  beamGroup.add(group);

  // Plateau plat circulaire (cylindre très court)
  const plateG = new THREE.CylinderGeometry(0.72, 0.72, 0.04, 64);
  const plate  = new THREE.Mesh(plateG, M.plate);
  plate.castShadow = true; plate.receiveShadow = true;
  group.add(plate);

  // Bord du plateau (tore fin pour l'arête)
  const rimG = new THREE.TorusGeometry(0.72, 0.02, 12, 64);
  const rim  = new THREE.Mesh(rimG, M.steel);
  rim.rotation.x = Math.PI/2;
  rim.position.y = 0.02;
  group.add(rim);

  return group;
}
const bowlL = makeBowl(-4.8);
const bowlR = makeBowl( 4.8);

/* ─── GROUPES DE POIDS ─── */
const wgL = new THREE.Group();
const wgR = new THREE.Group();
beamGroup.add(wgL);
beamGroup.add(wgR);

function clearG(g) { while(g.children.length) g.remove(g.children[0]); }

// Créer texture métal brossé LOV — argenté clair avec micro-stries
function makeMetalTexture(text, baseColor) {
  const canvas = document.createElement('canvas');
  canvas.width = 512;
  canvas.height = 512;
  const ctx = canvas.getContext('2d');
  
  // Base argentée claire
  ctx.fillStyle = baseColor;
  ctx.fillRect(0, 0, 512, 512);
  
  // Stries brossées horizontales très fines (comme la photo)
  ctx.globalAlpha = 0.04;
  for(let i = 0; i < 512; i += 1) {
    const variation = Math.random();
    ctx.fillStyle = variation > 0.5 ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
    ctx.fillRect(0, i, 512, 1);
  }
  ctx.globalAlpha = 1;
  
  // Gravure très subtile (à peine visible comme sur LOV)
  ctx.shadowColor = 'rgba(0,0,0,0.2)';
  ctx.shadowBlur = 2;
  ctx.shadowOffsetX = 1;
  ctx.shadowOffsetY = 1;
  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.font = 'italic 280px Georgia, serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, 258, 266);
  
  // Highlight très léger
  ctx.shadowColor = 'transparent';
  ctx.fillStyle = 'rgba(255,255,255,0.08)';
  ctx.fillText(text, 254, 262);
  
  const texture = new THREE.CanvasTexture(canvas);
  texture.needsUpdate = true;
  return texture;
}

// Normal map pour stries brossées
function makeNormalMap() {
  const canvas = document.createElement('canvas');
  canvas.width = 512;
  canvas.height = 512;
  const ctx = canvas.getContext('2d');
  
  // Base normal
  ctx.fillStyle = '#8080ff';
  ctx.fillRect(0, 0, 512, 512);
  
  // Stries horizontales fines
  ctx.globalAlpha = 0.2;
  for(let i = 0; i < 512; i += 2) {
    const h = Math.random() * 15 + 120;
    ctx.fillStyle = `rgb(${h}, ${h}, 255)`;
    ctx.fillRect(0, i, 512, 1);
  }
  
  const texture = new THREE.CanvasTexture(canvas);
  texture.needsUpdate = true;
  return texture;
}

// Poids x — argenté clair LOV
function makeWeightX() {
  const g = new THREE.BoxGeometry(0.36, 0.36, 0.36);
  
  const albedo = makeMetalTexture('x', '#e2ded8');
  const normal = makeNormalMap();
  
  const mat = new THREE.MeshStandardMaterial({
    map: albedo,
    normalMap: normal,
    normalScale: new THREE.Vector2(0.3, 0.3),
    color: 0xe2ded8,        // argenté clair
    roughness: 0.24,        // brossé satiné
    metalness: 0.97,
    envMapIntensity: 1.8,
  });
  
  const mesh = new THREE.Mesh(g, mat);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  return mesh;
}

// Poids 1 — légèrement plus sombre
function makeWeight1() {
  const g = new THREE.BoxGeometry(0.26, 0.26, 0.26);
  
  const albedo = makeMetalTexture('1', '#d8d4d0');
  const normal = makeNormalMap();
  
  const mat = new THREE.MeshStandardMaterial({
    map: albedo,
    normalMap: normal,
    normalScale: new THREE.Vector2(0.3, 0.3),
    color: 0xd8d4d0,
    roughness: 0.26,
    metalness: 0.96,
    envMapIntensity: 1.8,
  });
  
  const mesh = new THREE.Mesh(g, mat);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  return mesh;
}

function buildWeights(wGroup, xBase, W, yBase) {
  clearG(wGroup);
  const items = [];
  for(let i=0;i<W.x;i++) items.push('x');
  for(let i=0;i<W.n;i++) items.push('n');
  if(!items.length) return;

  // Trier : les gros (x) en bas, les petits (1) au-dessus
  items.sort((a, b) => a === 'x' ? -1 : 1);

  const cubeX = 0.36;  // taille cube x
  const cube1 = 0.26;  // taille cube 1
  const gap = 0.02;    // petit espace entre cubes

  // Disposition : piles verticales, max 2 colonnes
  const cols = Math.min(items.length, 2);
  const colSpacing = 0.45;
  
  let currentCol = 0;
  let heightInCol = [];
  for(let i = 0; i < cols; i++) heightInCol[i] = 0;

  items.forEach((t, i) => {
    const cubeSize = t === 'x' ? cubeX : cube1;
    const halfSize = cubeSize / 2;
    
    // Position X : centré sur le plateau avec espacement entre colonnes
    const offsetX = cols === 1 ? 0 : (currentCol - (cols-1)/2) * colSpacing;
    const wx = xBase + offsetX;
    
    // Position Y : posé sur le plateau (yBase = position plateau)
    // Le plateau a 0.04 d'épaisseur, donc le haut est à yBase + 0.02
    const wy = yBase + 0.02 + halfSize + heightInCol[currentCol];
    
    const mesh = t === 'x' ? makeWeightX() : makeWeight1();
    mesh.position.set(wx, wy, 0);
    wGroup.add(mesh);
    
    // Incrémenter la hauteur de cette colonne
    heightInCol[currentCol] += cubeSize + gap;
    
    // Alterner les colonnes
    currentCol = (currentCol + 1) % cols;
  });
}

/* ─── SOL — ombre douce taupe chaud bas-droite ─── */
// Ombre portée : douce, longue, vers bas-droite, taupe chaud #b0a090
const floorM = new THREE.ShadowMaterial({
  opacity: 0.10,        // très douce comme dans la photo
  color: 0xa09080,      // taupe rosé chaud
});
const floor = new THREE.Mesh(new THREE.PlaneGeometry(24, 24), floorM);
floor.rotation.x = -Math.PI/2;
floor.position.y = -3.5;
floor.receiveShadow = true;
scene.add(floor);

// Second plan de réception plus loin (fond du cyclo)
const backdropM = new THREE.ShadowMaterial({ opacity: 0.04, color: 0xb0a090 });
const backdrop = new THREE.Mesh(new THREE.PlaneGeometry(24, 20), backdropM);
backdrop.position.set(2, 0, -4);   // légèrement décalé droite comme la photo
backdrop.receiveShadow = true;
scene.add(backdrop);

/* ─── GRAIN POST-PROCESS sur le canvas Three.js ───
   La photo a du grain visible sur le métal lui-même.
   On ajoute un canvas grain qui se dessine par-dessus le rendu 3D. */
const grainCanvas = document.createElement('canvas');
grainCanvas.style.cssText = 'position:fixed;inset:0;z-index:3;pointer-events:none;mix-blend-mode:overlay;opacity:0.38;';
document.body.appendChild(grainCanvas);

const grainCtx = grainCanvas.getContext('2d');

function resizeGrain() {
  grainCanvas.width  = innerWidth;
  grainCanvas.height = innerHeight;
}
resizeGrain();
window.addEventListener('resize', resizeGrain);

let grainFrame = 0;
function drawGrain() {
  grainFrame++;
  // Redessiner le grain tous les 3 frames pour l'effet argentique vivant
  if(grainFrame % 3 !== 0) return;

  const w = grainCanvas.width, h = grainCanvas.height;
  const imageData = grainCtx.createImageData(w, h);
  const data = imageData.data;

  for(let i = 0; i < data.length; i += 4) {
    // Grain argentique chaud : légèrement teinté beige/or
    const noise = (Math.random() - 0.5) * 52;
    const warm  = noise > 0 ? noise * 0.12 : 0;  // légère teinte chaude dans les hautes lumières
    data[i]   = 128 + noise + warm;   // R
    data[i+1] = 128 + noise;           // G
    data[i+2] = 128 + noise - warm*0.5;// B (légèrement froid)
    data[i+3] = 255;
  }
  grainCtx.putImageData(imageData, 0, 0);
}

/* Overlay de teinte chaude globale — reproduit le cast beige de la photo */
const warmOverlay = document.createElement('div');
warmOverlay.style.cssText = `
  position:fixed; inset:0; z-index:4; pointer-events:none;
  background: radial-gradient(
    ellipse 65% 55% at 12% 10%,
    rgba(255,248,235,0.12) 0%,
    transparent 55%
  );
  mix-blend-mode: screen;
`;
document.body.appendChild(warmOverlay);
let tiltTarget = 0, tiltCurrent = 0, idle = 0;

function updateBalance() {
  tiltCurrent += (tiltTarget - tiltCurrent) * 0.07;
  idle += 0.007;
  // micro-oscillation naturelle
  beamGroup.rotation.z = tiltCurrent + Math.sin(idle * 1.2) * 0.003;
}

const clock = new THREE.Clock();
function render() {
  requestAnimationFrame(render);
  updateBalance();
  // légère rotation lente de l'ensemble pour l'aspect sculptural
  root.rotation.y = Math.sin(clock.getElapsedTime() * 0.1) * 0.06;
  renderer.render(scene, camera);
  drawGrain();  // grain argentique sur le métal
}
render();

window.addEventListener('resize', () => {
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

/* ─── MISE À JOUR VISUELLE ─── */
function refreshWeights() {
  buildWeights(wgL, -4.8, L, -1.95);
  buildWeights(wgR,  4.8, R, -1.95);
}
function setTilt() {
  const ex = getEx(); if(!ex) return;
  const d = L.x*ex.s + L.n - (R.x*ex.s + R.n);
  tiltTarget = Math.max(-0.24, Math.min(0.24, d * -0.028));
}
/* ═══════════════════════════════════════════════════════════════
   PARCOURS PÉDAGOGIQUE COLLÈGE — ÉQUATIONS
   
   Progression rigoureuse de la 6ème à la 3ème
   Chaque niveau introduit progressivement de nouveaux concepts
   
   Structure : 
   - 6ème : Découverte de l'inconnue (5 exercices)
   - 5ème : Introduction multiplication et divisions (6 exercices)
   - 4ème : Équations à deux étapes (7 exercices)
   - 3ème : Équations complexes avec x des deux côtés (8 exercices)
   
   Total : 26 équations du plus simple au plus complexe
═══════════════════════════════════════════════════════════════ */

const GR = {
  
  "6ème": { 
    tot: 5,
    desc: "Découverte de l'inconnue",
    ex: [
      // Niveau 1 : x seul = nombre
      {
        type: "Égalité directe",
        hi: "x est seul à gauche. Ajoute des poids de 1 à droite jusqu'à l'équilibre.",
        e: {lx:1, ln:0, rx:0, rn:3},
        s: 3
      },
      // Niveau 2 : x + petit nombre = résultat
      {
        type: "x + b = c (simple)",
        hi: "Retire 2 des deux côtés pour isoler x.",
        e: {lx:1, ln:2, rx:0, rn:5},
        s: 3
      },
      {
        type: "x + b = c",
        hi: "Retire 3 des deux plateaux en même temps.",
        e: {lx:1, ln:3, rx:0, rn:8},
        s: 5
      },
      // Niveau 3 : x + nombre moyen
      {
        type: "x + b = c",
        hi: "x + 4 = 10 — retire 4 de chaque côté.",
        e: {lx:1, ln:4, rx:0, rn:10},
        s: 6
      },
      {
        type: "x + b = c",
        hi: "x + 5 = 12 — retire 5 pour trouver x.",
        e: {lx:1, ln:5, rx:0, rn:12},
        s: 7
      }
    ]
  },
  
  "5ème": {
    tot: 6,
    desc: "Multiplication et division",
    ex: [
      // Niveau 1 : ax = c (coefficient simple)
      {
        type: "2x = c",
        hi: "2x = 6. Deux flèches x valent 6. Retire une flèche de chaque côté.",
        e: {lx:2, ln:0, rx:0, rn:6},
        s: 3
      },
      {
        type: "3x = c",
        hi: "3x = 9. Retire des x jusqu'à n'en avoir qu'un seul.",
        e: {lx:3, ln:0, rx:0, rn:9},
        s: 3
      },
      // Niveau 2 : ax = c (coefficient plus grand)
      {
        type: "2x = c",
        hi: "2x = 10. Retire 1 flèche x de chaque côté.",
        e: {lx:2, ln:0, rx:0, rn:10},
        s: 5
      },
      // Niveau 3 : ax + b = c (première combinaison)
      {
        type: "2x + b = c",
        hi: "Étape 1 : retire les 1. Étape 2 : retire les x.",
        e: {lx:2, ln:1, rx:0, rn:7},
        s: 3
      },
      {
        type: "2x + b = c",
        hi: "2x + 3 = 11 → retire 3 → 2x = 8 → retire x → x = 4",
        e: {lx:2, ln:3, rx:0, rn:11},
        s: 4
      },
      {
        type: "3x + b = c",
        hi: "3x + 2 = 14 → retire 2 → 3x = 12 → x = 4",
        e: {lx:3, ln:2, rx:0, rn:14},
        s: 4
      }
    ]
  },
  
  "4ème": {
    tot: 7,
    desc: "Équations à deux étapes",
    ex: [
      // Niveau 1 : ax + b = c (valeurs moyennes)
      {
        type: "2x + b = c",
        hi: "2x + 4 = 12 → retire 4 → 2x = 8 → x = 4",
        e: {lx:2, ln:4, rx:0, rn:12},
        s: 4
      },
      {
        type: "3x + b = c",
        hi: "3x + 3 = 15 → retire 3 → 3x = 12 → x = 4",
        e: {lx:3, ln:3, rx:0, rn:15},
        s: 4
      },
      // Niveau 2 : Coefficients plus grands
      {
        type: "4x + b = c",
        hi: "4x + 2 = 18 → retire 2 → 4x = 16 → x = 4",
        e: {lx:4, ln:2, rx:0, rn:18},
        s: 4
      },
      {
        type: "3x + b = c",
        hi: "3x + 5 = 20 → retire 5 → 3x = 15 → x = 5",
        e: {lx:3, ln:5, rx:0, rn:20},
        s: 5
      },
      // Niveau 3 : Nombres plus grands
      {
        type: "5x + b = c",
        hi: "5x + 3 = 23 → retire 3 → 5x = 20 → x = 4",
        e: {lx:5, ln:3, rx:0, rn:23},
        s: 4
      },
      {
        type: "4x + b = c",
        hi: "4x + 7 = 27 → retire 7 → 4x = 20 → x = 5",
        e: {lx:4, ln:7, rx:0, rn:27},
        s: 5
      },
      {
        type: "3x + b = c",
        hi: "3x + 8 = 23 → retire 8 → 3x = 15 → x = 5",
        e: {lx:3, ln:8, rx:0, rn:23},
        s: 5
      }
    ]
  },
  
  "3ème": {
    tot: 8,
    desc: "Équations complexes",
    ex: [
      // Niveau 1 : x des deux côtés (introduction)
      {
        type: "ax + b = x + d",
        hi: "2x + 1 = x + 4. Retire 1x de chaque côté d'abord.",
        e: {lx:2, ln:1, rx:1, rn:4},
        s: 3
      },
      {
        type: "ax + b = x + d",
        hi: "3x + 2 = x + 8. Retire x des deux côtés → 2x + 2 = 8.",
        e: {lx:3, ln:2, rx:1, rn:8},
        s: 3
      },
      // Niveau 2 : Coefficients variés
      {
        type: "ax + b = cx + d",
        hi: "4x + 1 = 2x + 7 → retire 2x → 2x + 1 = 7 → x = 3",
        e: {lx:4, ln:1, rx:2, rn:7},
        s: 3
      },
      {
        type: "ax + b = x + d",
        hi: "3x + 5 = x + 11 → retire x → 2x + 5 = 11 → x = 3",
        e: {lx:3, ln:5, rx:1, rn:11},
        s: 3
      },
      // Niveau 3 : Plus complexe
      {
        type: "ax + b = cx + d",
        hi: "5x + 2 = 2x + 14 → retire 2x → 3x + 2 = 14 → x = 4",
        e: {lx:5, ln:2, rx:2, rn:14},
        s: 4
      },
      {
        type: "ax + b = cx + d",
        hi: "4x + 3 = x + 15 → retire x → 3x + 3 = 15 → x = 4",
        e: {lx:4, ln:3, rx:1, rn:15},
        s: 4
      },
      // Niveau 4 : Équations élaborées
      {
        type: "ax + b = cx + d",
        hi: "6x + 1 = 3x + 13 → retire 3x → 3x + 1 = 13 → x = 4",
        e: {lx:6, ln:1, rx:3, rn:13},
        s: 4
      },
      {
        type: "ax + b = cx + d",
        hi: "5x + 4 = 2x + 19 → retire 2x → 3x + 4 = 19 → x = 5",
        e: {lx:5, ln:4, rx:2, rn:19},
        s: 5
      }
    ]
  }
  
};

const ORD = ["6ème","5ème","4ème","3ème"];

let grade="6ème", idx=0, score=0, nhints=0, done=false, pendU=null;
let P={"6ème":{c:0,u:true},"5ème":{c:0,u:false},"4ème":{c:0,u:false},"3ème":{c:0,u:false}};
let L={x:0,n:0}, R={x:0,n:0}, hist=[];

function getEx() { return GR[grade].ex[idx]; }

function load() {
  const ex = getEx(); if(!ex) return;
  L={x:ex.e.lx,n:ex.e.ln}; R={x:ex.e.rx,n:ex.e.rn};
  hist=[]; nhints=0; done=false;
  document.getElementById('hbox').style.display='none';
  refreshWeights(); setTilt(); updEq(); updSt(); updBt(); updPg();
}

function go(side, action, type) {
  if(done) return;
  const T = side==='l' ? L : R;
  if(action==='a') { if(type==='x') T.x++; else T.n++; }
  else {
    if(type==='x'&&T.x>0) T.x--;
    else if(type==='n'&&T.n>0) T.n--;
    else return;
  }
  clk();
  hist.push({op:`${action==='a'?'+':'−'}${type==='x'?'x':'1'} ${side==='l'?'gauche':'droite'}`,L:{...L},R:{...R}});
  refreshWeights(); setTilt(); updEq(); updSt(); updBt(); rH();
}

/* Diviser par N */
let pendingDivSide = null;

function divide(side) {
  if(done) return;
  pendingDivSide = side;
  showDivSelector();
}

function showDivSelector() {
  const T = pendingDivSide === 'l' ? L : R;
  
  // Calculer quels diviseurs sont possibles (de 2 à 10)
  const options = [];
  for(let d = 2; d <= 10; d++) {
    // Vérifier si les DEUX côtés sont divisibles par d
    const canDivL = L.x % d === 0 && L.n % d === 0;
    const canDivR = R.x % d === 0 && R.n % d === 0;
    if(canDivL && canDivR && (L.x > 0 || L.n > 0 || R.x > 0 || R.n > 0)) {
      options.push(d);
    }
  }
  
  // Générer les boutons
  const container = document.getElementById('divOptions');
  container.innerHTML = Array.from({length: 9}, (_, i) => i + 2).map(d => {
    const enabled = options.includes(d);
    return `<div class="div-opt" data-disabled="${!enabled}" onclick="${enabled ? `applyDivision(${d})` : ''}">${d}</div>`;
  }).join('');
  
  document.getElementById('divSelector').classList.add('show');
}

function closeDivSelector() {
  document.getElementById('divSelector').classList.remove('show');
  pendingDivSide = null;
}

function applyDivision(divisor) {
  // Diviser les deux côtés par le diviseur
  L.x = Math.floor(L.x / divisor);
  L.n = Math.floor(L.n / divisor);
  R.x = Math.floor(R.x / divisor);
  R.n = Math.floor(R.n / divisor);
  
  clk();
  hist.push({op:`÷${divisor} des deux côtés`, L:{...L}, R:{...R}});
  refreshWeights(); setTilt(); updEq(); updSt(); updBt(); rH();
  closeDivSelector();
}

/* Affichage équation */
function fE(s) {
  let p=[];
  if(s.x>0) p.push(`<span class="xp">${s.x>1?s.x+'x':'x'}</span>`);
  if(s.n>0) p.push(`<span class="np">${s.n}</span>`);
  return p.join(' + ') || `<span class="np">0</span>`;
}
function updEq() {
  document.getElementById('eDisp').innerHTML=`${fE(L)} = ${fE(R)}`;
}

/* État balance */
function updSt() {
  const ex=getEx(); if(!ex) return;
  const lv=L.x*ex.s+L.n, rv=R.x*ex.s+R.n, d=lv-rv;
  const el=document.getElementById('eSt');
  el.className='eq-state';
  const tot=L.x+L.n+R.x+R.n;
  if(d===0&&tot>0){
    const xA=(L.x===1&&L.n===0&&R.x===0&&R.n>0)||(R.x===1&&R.n===0&&L.x===0&&L.n>0);
    if(xA){ el.className='eq-state show solved'; el.textContent=`x = ${ex.s}`;
      if(!done){done=true; setTimeout(win,420);}
    } else { el.className='eq-state show'; el.textContent='Équilibrée — simplifie encore pour isoler x'; }
  } else if(d>0){ el.className='eq-state show heavy'; el.textContent='Gauche trop lourd'; }
  else if(d<0){   el.className='eq-state show heavy'; el.textContent='Droite trop lourd'; }
  else {          el.className='eq-state show'; el.textContent='Manipule les plateaux pour isoler x'; }
}

function updBt() {
  const s=(id,v)=>document.getElementById(id).setAttribute('data-off',String(!v));
  s('rlx',L.x>0); s('rln',L.n>0); s('rrx',R.x>0); s('rrn',R.n>0);
  
  // Boutons diviser : actifs si au moins un diviseur (2 à 10) est possible
  let canDiv = false;
  for(let d = 2; d <= 10; d++) {
    const canDivL = L.x % d === 0 && L.n % d === 0;
    const canDivR = R.x % d === 0 && R.n % d === 0;
    if(canDivL && canDivR && (L.x > 0 || L.n > 0 || R.x > 0 || R.n > 0)) {
      canDiv = true;
      break;
    }
  }
  s('dL', canDiv);
  s('dR', canDiv);
}

/* Historique */
const Ns=['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮'];
function fS(s) {
  let p=[];
  if(s.x>0) p.push(`<span class="xv">${s.x>1?s.x+'x':'x'}</span>`);
  if(s.n>0) p.push(`<span class="nv">${s.n}</span>`);
  return p.join(' + ')||'<span class="nv">0</span>';
}
function rH() {
  const el=document.getElementById('steps'), ex=getEx(); if(!ex) return;
  const iL={x:ex.e.lx,n:ex.e.ln}, iR={x:ex.e.rx,n:ex.e.rn};
  let h=`<div class="step s0"><div class="sn">${Ns[0]}</div><div class="so">départ</div><div class="se">${fS(iL)} = ${fS(iR)}</div></div>`;
  hist.forEach((s,i)=>{
    const ok=(s.L.x===1&&s.L.n===0&&s.R.x===0)||(s.R.x===1&&s.R.n===0&&s.L.x===0);
    h+=`<div class="step ${ok?'sok':''}"><div class="sn">${Ns[i+1]||i+2}</div><div class="so">${s.op}</div><div class="se">${fS(s.L)} = ${fS(s.R)}</div></div>`;
  });
  el.innerHTML=h; el.scrollTop=el.scrollHeight;
}

/* Succès */
function win() {
  const ex=getEx(); ply();
  const pts=nhints===0?15:10; score+=pts;
  document.getElementById('sc').textContent=score;
  document.getElementById('oE').textContent=`x = ${ex.s}`;
  document.getElementById('oS').textContent=nhints===0?`Sans indice — +${pts} points`:`+${pts} points`;
  document.getElementById('oI').textContent=nhints===0?'✦':'◇';
  document.getElementById('ovS').classList.add('show');
  P[grade].c++;
  const gi=ORD.indexOf(grade);
  if(P[grade].c>=GR[grade].tot&&gi<ORD.length-1) pendU=ORD[gi+1];
}
function closeS() {
  document.getElementById('ovS').classList.remove('show'); updPg();
  if(pendU){const g=pendU;pendU=null;setTimeout(()=>showU(g),260);}
}
function showU(g) {
  P[g].u=true;
  const m={"5ème":"Maîtrise des équations de 6ème.","4ème":"Place aux équations du premier degré.","3ème":"Les équations élaborées t'attendent."};
  document.getElementById('oUT').innerHTML=`${g}<br>débloqué.`;
  document.getElementById('oUS').textContent=m[g]||'';
  document.getElementById('ovU').classList.add('show'); updPg();
}
function closeU() {
  document.getElementById('ovU').classList.remove('show');
  grade=ORD[ORD.indexOf(grade)+1]||grade; idx=0; load();
}

/* Navigation */
function doNext() { idx=Math.min(idx+1,GR[grade].ex.length-1); load(); }
function doReset() { load(); }
function showHint() {
  const ex=getEx(); if(!ex) return; nhints++;
  const b=document.getElementById('hbox'); b.textContent=ex.hi; b.style.display='block';
  setTimeout(()=>b.style.display='none', 6000);
}
function swG(g) {
  if(!P[g].u) return; grade=g;
  idx=P[g].c; if(idx>=GR[g].ex.length) idx=GR[g].ex.length-1;
  load();
}
function toggleH() {
  document.getElementById('hPanel').classList.toggle('open'); rH();
}

/* Tableau de bord */
function toggleDash() {
  const dash = document.getElementById('dashboard');
  const isOpen = dash.classList.contains('show');
  if(isOpen) {
    dash.classList.remove('show');
  } else {
    updDash();
    dash.classList.add('show');
  }
}

function updDash() {
  // Stats globales
  const totalSolved = ORD.reduce((sum, g) => sum + P[g].c, 0);
  const totalEqs = ORD.reduce((sum, g) => sum + GR[g].tot, 0);
  document.getElementById('statTotal').textContent = `${totalSolved} / ${totalEqs}`;
  document.getElementById('statScore').textContent = score;
  
  // Compter les équations résolues sans indice (à implémenter avec tracking)
  document.getElementById('statPerfect').textContent = '—';
  
  // Générer les cartes de niveaux
  const container = document.getElementById('dashLevels');
  container.innerHTML = ORD.map(g => {
    const data = P[g];
    const gradeData = GR[g];
    const total = gradeData.tot;
    const pct = (data.c / total * 100).toFixed(0);
    const isComplete = data.c >= total;
    const isLocked = !data.u;
    
    let badge = 'En cours';
    let badgeClass = '';
    if(isLocked) { badge = 'Verrouillé'; badgeClass = 'locked'; }
    else if(isComplete) { badge = 'Complété'; badgeClass = 'complete'; }
    
    // Extraire les types uniques d'équations pour ce niveau
    const types = [...new Set(gradeData.ex.map(ex => ex.type))];
    
    return `
      <div class="level-card ${isLocked ? 'locked' : ''}">
        <div class="level-header">
          <div class="level-name">${g}</div>
          <div class="level-badge ${badgeClass}">${badge}</div>
        </div>
        <div class="level-prog">
          <div class="level-bar">
            <div class="level-bar-fill" style="width:${pct}%"></div>
          </div>
          <div class="level-frac">${data.c} / ${total}</div>
        </div>
        <div style="font-family:var(--mono); font-size:0.48rem; color:var(--taupe); margin:10px 0 8px 0; letter-spacing:0.08em;">${gradeData.desc}</div>
        <div class="level-types">
          ${types.map(t => `<div class="type-tag">${t}</div>`).join('')}
        </div>
      </div>
    `;
  }).join('');
}

/* Progression */
function updPg() {
  const d=P[grade], tot=GR[grade].tot;
  document.getElementById('pFill').style.width=(d.c/tot*100)+'%';
  document.getElementById('pTxt').textContent=`${d.c} / ${tot}`;
}

/* Audio */
let aC=null;
const gAC=()=>{if(!aC)aC=new(window.AudioContext||window.webkitAudioContext)();return aC;};
function clk(){
  try{
    const a=gAC(),t=a.currentTime;
    const o1=a.createOscillator(),o2=a.createOscillator(),g=a.createGain(),f=a.createBiquadFilter();
    f.type='bandpass'; f.frequency.value=1300; f.Q.value=10;
    o1.type='square'; o1.frequency.setValueAtTime(900,t); o1.frequency.exponentialRampToValueAtTime(280,t+0.13);
    o2.type='square'; o2.frequency.setValueAtTime(1350,t); o2.frequency.exponentialRampToValueAtTime(420,t+0.13);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.1,t+0.003); g.gain.exponentialRampToValueAtTime(0.001,t+0.16);
    [o1,o2].forEach(o=>o.connect(f)); f.connect(g); g.connect(a.destination);
    o1.start(t);o2.start(t);o1.stop(t+0.18);o2.stop(t+0.18);
  }catch(e){}
}
function ply(){
  try{
    const a=gAC(),t=a.currentTime;
    [[0,523,659,784],[0.1,587,740,880],[0.2,659,830,988]].forEach(([dt,...fs])=>{
      fs.forEach(f2=>{
        const o=a.createOscillator(),g=a.createGain();
        o.type='sine'; o.frequency.value=f2;
        g.gain.setValueAtTime(0,t+dt); g.gain.linearRampToValueAtTime(0.055,t+dt+0.02); g.gain.exponentialRampToValueAtTime(0.001,t+dt+0.45);
        o.connect(g); g.connect(a.destination); o.start(t+dt); o.stop(t+dt+0.5);
      });
    });
  }catch(e){}
}

/* Init */
load();
</script>
</body>
</html>
